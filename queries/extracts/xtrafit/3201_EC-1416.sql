-- The extract is extracted from Exerp on 2026-02-08
--  
 WITH params AS ( SELECT /*+ materialize */ to_date(:date_start,'YYYY-MM-DD') AS PeriodStartDate, to_date(:date_end,'YYYY-MM-DD') AS PeriodEndDate, id as center FROM CENTERS ) , CALCULATION AS ( SELECT sfp.id as id, sfp.start_date as test, sfp.subscription_center as subscription_center, sfp.subscription_id as subscription_id, (CASE WHEN sfp.start_date <= PeriodStartDate THEN PeriodStartDate ELSE sfp.start_date END) AS freezestartdate, (CASE WHEN sfp.end_date>= PeriodEndDate THEN PeriodEndDate ELSE sfp.end_date END) AS freezeenddate FROM subscription_reduced_period sfp JOIN PARAMS ON PARAMS.center = sfp.subscription_center ) SELECT sp.id as freezeid, s.OWNER_CENTER || 'p' || s.OWNER_ID AS PersonId, s.OWNER_CENTER AS CENTER, s.CENTER||'ss' || s.ID as subscriptionID, TO_CHAR(sp.start_date, 'DD.MM.YYYY') AS original_Startdate, TO_CHAR(sp.end_date, 'DD.MM.YYYY') AS original_Enddate, (CAST( c.freezeenddate AS date) - CAST( c.freezestartdate AS date))+1 AS days, sp.text as freezeText, (CASE WHEN sp.start_date <= PeriodStartDate THEN PeriodStartDate ELSE sp.start_date END) AS adjustedfreezestartdate, (CASE WHEN sp.end_date>= PeriodEndDate THEN PeriodEndDate ELSE sp.end_date END) AS adjustedfreezeenddate, sp.type as freezetype FROM subscription_reduced_period sp JOIN SUBSCRIPTIONS s ON sp.subscription_center = s.center AND sp.subscription_id = s.id JOIN PERSONS p ON s.OWNER_CENTER = p.center AND s.OWNER_ID = p.id JOIN CALCULATION c ON c.subscription_center = sp.subscription_center AND c.id = sp.id JOIN PARAMS ON PARAMS.center = s.center WHERE ((sp.start_date >= PARAMS.PeriodStartDate AND sp.start_date <= PARAMS.PeriodEnddate) OR (sp.end_date >= PARAMS.PeriodStartDate AND sp.end_date <= PARAMS.PeriodEnddate)OR (sp.start_date <= PARAMS.PeriodStartDate AND sp.end_date >=PARAMS.PeriodEnddate)) --AND s.state in (2,4) --confirm with XTRAFIT AND sp.state ='ACTIVE' AND p.PERSONTYPE NOT IN (8) AND c.subscription_center=:center --AND s.id =3014 