WITH params AS ( SELECT /*+ materialize */ CAST ($$FromDate$$ AS DATE) AS StartDate, CAST($$ToDate$$ AS DATE) AS EndDate, c.id AS center, c.shortname FROM centers c WHERE c.id IN ($$Scope$$) ) , free_freeze_period AS ( SELECT srp.subscription_center AS subscription_center, srp.subscription_id AS subscription_id, srp.start_date AS original_startdate, srp.end_date AS original_enddate, CASE WHEN srp.start_date <= params.StartDate THEN params.StartDate ELSE srp.start_date END AS adjusted_startdate, CASE WHEN srp.end_date >= params.EndDate THEN params.EndDate ELSE srp.end_date END AS adjusted_enddate, srp.text, srp.type, NULL AS freezeType FROM subscription_reduced_period srp JOIN params ON params.center = srp.subscription_center WHERE srp.state = 'ACTIVE' AND srp.type IN ('SAVED_FREE_DAYS_USE', 'FREE_ASSIGNMENT') AND srp.start_date <= params.EndDate AND srp.end_date >= params.StartDate UNION SELECT sfp.subscription_center AS subscription_center, sfp.subscription_id AS subscription_id, sfp.start_date AS original_startdate, sfp.end_date AS original_enddate, CASE WHEN sfp.start_date <= params.StartDate THEN params.StartDate ELSE sfp.start_date END AS adjusted_startdate, CASE WHEN sfp.end_date >= params.EndDate THEN params.EndDate ELSE sfp.end_date END AS adjusted_enddate, sfp.text, 'FREEZE' AS type, sfp.type AS freezeType FROM subscription_freeze_period sfp JOIN params ON params.center = sfp.subscription_center WHERE sfp.state = 'ACTIVE' AND sfp.start_date <= params.EndDate AND sfp.end_date >= params.StartDate ) SELECT s.owner_center || 'p' || s.owner_id AS PersonId, s.owner_center AS CenterId, params.shortname AS CenterName, s.center || 'ss' || s.id AS SubscriptionId, s.start_date AS SubscriptionStartDate, s.end_date AS SubscriptionendDate, CASE s.state WHEN 2 THEN 'ACTIVE' WHEN 3 THEN 'ENDED' WHEN 4 THEN 'FROZEN' WHEN 7 THEN 'WINDOW' WHEN 8 THEN 'CREATED' ELSE 'UNKNOWN' END AS SubscriptionStatus , freeFrezePeriod.original_startdate, freeFrezePeriod.original_enddate, (freeFrezePeriod.original_enddate - freeFrezePeriod.original_startdate) + 1 AS original_noofdays, freeFrezePeriod.adjusted_startdate, freeFrezePeriod.adjusted_enddate, (freeFrezePeriod.adjusted_enddate - freeFrezePeriod.adjusted_startdate) + 1 AS adjusted_noofdays, freeFrezePeriod.text, freeFrezePeriod.type, freeFrezePeriod.freezeType FROM subscriptions s JOIN params ON params.center = s.center JOIN free_freeze_period freeFrezePeriod ON freeFrezePeriod.subscription_center = s.center AND freeFrezePeriod.subscription_id = s.id