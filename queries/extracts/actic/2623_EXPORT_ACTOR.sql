-- The extract is extracted from Exerp on 2026-02-08
--  
WITH
    PARAMS AS
    (
        SELECT
                /*+ materialize */
				datetolongTZ(TO_CHAR(TRUNC(to_date(getcentertime(c.id), 'YYYY-MM-DD HH24:MI')-30), 'YYYY-MM-DD HH24:MI'),co.DEFAULTTIMEZONE) AS cutDate,
                c.ID AS CenterID
        FROM CENTERS c
        JOIN COUNTRIES co ON c.COUNTRY = co.ID
    )
SELECT DISTINCT
    E.IDENTITY  AS CARDNO,
    1           AS CARDSTATUS,
    P.FIRSTNAME AS NAME,
    P.LASTNAME,
	p.CENTER ||'p'||p.ID
FROM
    ENTITYIDENTIFIERS E
JOIN	
	PARAMS params ON params.CenterID = e.REF_CENTER
JOIN
    PERSONS P
ON
    (
        E.REF_CENTER = P.CENTER
    AND E.REF_ID = P.ID
    AND E.REF_TYPE = 1
    AND E.IDMETHOD = 1
    AND E.ENTITYSTATUS = 1)
LEFT JOIN
    SUBSCRIPTIONS S
ON
    (
        E.REF_CENTER = S.OWNER_CENTER
    AND E.REF_ID = S.OWNER_ID
    AND S.STATE IN (2,8)
    AND S.SUB_STATE != 9)
WHERE
    (
        S.CENTER IS NOT NULL
    AND s.CENTER IN (9229,182,78,122,184,183,186,191,193,195,194,196,192,199,55,179,9202,9203,9204,
                     9205,9207,9210,9211,9213,175,178,185,188,197,198,200,9206,9208,9209,9212,9214,
                     180,1,31,80,172,99,9215,50,140,155,18,19,29,6,8,9,16,20,21,23,24,77,108,133,
                     151,157,159,163,168,171,174,36,120,68,79,26,53,27,152,144,84,85,83,25,139,51,3
                     ,167,135,12,13,164,100,170,4,187,189,190,169,40,45,130,110,39,33,34,35,49,81,
                     102,129,131,134,143,150,154,158,57,14,32,54,58,76,136,145,173,56,52,66,142,10,
                     128,176,177,181,9221,9219,9220,9218,9216,9230, 9236, 9228))
OR  (
        E.REF_CENTER IN (9229,182,78,122,184,183,186,191,193,195,194,196,192,199,55,179,9202,9203,
                         9204,9205,9207,9210,9211,9213,175,178,185,188,197,198,200,9206,9208,9209,
                         9212,9214,180,1,31,80,172,99,9215,50,140,155,18,19,29,6,8,9,16,20,21,23,24
                         ,77,108,133,151,157,159,163,168,171,174,36,120,68,79,26,53,27,152,144,84,
                         85,83,25,139,51,3,167,135,12,13,164,100,170,4,187,189,190,169,40,45,130,
                         110,39,33,34,35,49,81,102,129,131,134,143,150,154,158,57,14,32,54,58,76,
                         136,145,173,56,52,66,142,10,128,176,177,181,9221,9219,9220,9218,9216,9230, 9236, 9228)
    AND (
            E.START_TIME >= params.cutDate))
