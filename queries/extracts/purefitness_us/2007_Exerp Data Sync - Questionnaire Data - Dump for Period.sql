-- The extract is extracted from Exerp on 2026-02-08
--  
-- TODO: QC IDs are copied from UK version, when US version of campaigns are ready. They should be replcaed with the corresponding IDs
-- Exerp_HY  2022-08-25

WITH
  params AS materialized
     (
         SELECT
             id   AS  center,
             CAST(datetolongC(TO_CHAR(CAST($$fromdate$$ AS DATE), 'YYYY-MM-DD HH24:MI'), id) AS BIGINT) AS  FROMDATE,
             CAST(datetolongC(TO_CHAR(CAST($$todate$$ AS DATE), 'YYYY-MM-DD HH24:MI'), id) AS BIGINT) + (86400 * 1000) AS TODATE,
             'YYYY-MM-DD HH24:MI:SS' AS DATETIMEFORMAT,
             time_zone  AS       TZFORMAT
         FROM 
             centers 
     )
SELECT
    cp.EXTERNAL_ID   AS "EXTERNALID",
	QC.QUESTIONNAIRE AS "QUESTIONNAIREID",
    QA.QUESTION_ID AS "QUESTIONID",
    case QC.QUESTIONNAIRE when 401 then 'Marketing Questionnaire' when 1801 then 'Welcome Goals' when 2001 then 'Marketing Questionnaire 2' end AS "SOURCE",
    (CASE
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=1 THEN 'Have you been a member of a gym before'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 THEN 'If yes please specify'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=3 THEN 'Would you utilise the services of a Personal Trainer'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=4 THEN 'Which mode of transport will you use most to get to the Gym'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 THEN 'Please select the way that you heard about us'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 THEN 'Whats your reason for joining PureGym'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=2 THEN 'How many times a week do you plan on visiting us to achieve your goal'
		WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=1 THEN 'Have you been a member of a gym before'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 THEN 'If yes please specify'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=3 THEN 'Would you utilise the services of a Personal Trainer'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=4 THEN 'Which mode of transport will you use most to get to the Gym'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 THEN 'Please select the way that you heard about us'
    END) AS "QUESTIONTEXT",
    (CASE
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=1 THEN 'Yes - Puregym'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=2 THEN 'Yes - Other'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=3 THEN 'No'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=1 THEN 'Fitness First'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=2 THEN 'LA Fitness'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=3 THEN 'Bannatynes'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=4 THEN 'The Gym Group'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=5 THEN 'Living Well'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=6 THEN 'Exercise 4 Less'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=7 THEN 'Fit4Less'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=8 THEN 'Total Fitness'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=9 THEN 'DW Fitness'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=10 THEN 'Virgin Active'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=11 THEN 'David Lloyd'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=12 THEN 'Other'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=3 AND QA.NUMBER_ANSWER=1 THEN 'Yes'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=3 AND QA.NUMBER_ANSWER=2 THEN 'No'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=1 THEN 'Bicycle'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=2 THEN 'Bus'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=3 THEN 'Car'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=4 THEN 'On foot'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=5 THEN 'Train'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=6 THEN 'Tube/Tram'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=1 THEN 'Radio'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=2 THEN 'Newspaper/Magazine'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=3 THEN 'Other'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=4 THEN 'Search Engine'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=5 THEN 'Billboard'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=6 THEN 'Passing by'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=7 THEN 'Restaurant'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=8 THEN 'Facebook/Twitter'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=9 THEN 'Freshers Fair'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=10 THEN 'Email'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=11 THEN 'Leaflet - through door'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=12 THEN 'Friend/Colleague'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=13 THEN 'Leaflet - on street'
        WHEN QC.QUESTIONNAIRE=401 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=14 THEN 'TV'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=1 THEN 'General fitness'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=2 THEN 'Training for an event'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=3 THEN 'Strength training'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=4 THEN 'Muscle gain'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=5 THEN 'Weight loss'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=6 THEN 'Toning up'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=7 THEN 'Socialising'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=8 THEN 'Injury rehabilitation'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=1 THEN 'Once a week'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=2 THEN 'Twice a week'
        WHEN QC.QUESTIONNAIRE=1801 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=3 THEN '3+ times a week'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=1 THEN 'Yes - Puregym'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=2 THEN 'Yes - Other'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=1 AND QA.NUMBER_ANSWER=3 THEN 'No'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=1 THEN 'Fitness First'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=2 THEN 'LA Fitness'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=3 THEN 'Bannatynes'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=4 THEN 'The Gym Group'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=5 THEN 'Living Well'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=6 THEN 'Exercise 4 Less'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=7 THEN 'Fit4Less'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=8 THEN 'Total Fitness'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=9 THEN 'DW Fitness'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=10 THEN 'Virgin Active'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=11 THEN 'David Lloyd'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=2 AND QA.NUMBER_ANSWER=12 THEN 'Other'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=3 AND QA.NUMBER_ANSWER=1 THEN 'Yes'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=3 AND QA.NUMBER_ANSWER=2 THEN 'No'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=1 THEN 'Bicycle'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=2 THEN 'Bus'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=3 THEN 'Car'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=4 THEN 'On foot'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=5 THEN 'Train'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=6 THEN 'Tube/Tram'
		WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=4 AND QA.NUMBER_ANSWER=7 THEN 'Mobility Aid'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=1 THEN 'Radio'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=2 THEN 'Newspaper/Magazine'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=3 THEN 'Other'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=4 THEN 'Search Engine'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=5 THEN 'Billboard'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=6 THEN 'Passing by'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=7 THEN 'Restaurant'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=8 THEN 'Facebook/Twitter'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=9 THEN 'Freshers Fair'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=10 THEN 'Email'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=11 THEN 'Leaflet - through door'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=12 THEN 'Friend/Colleague'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=13 THEN 'Leaflet - on street'
        WHEN QC.QUESTIONNAIRE=2001 AND QA.QUESTION_ID=5 AND QA.NUMBER_ANSWER=14 THEN 'TV'        
    END) AS "ANSWERTEXT",
    TO_CHAR(longtodatetz(QUN.LOG_TIME,params.TZFORMAT),params.DATETIMEFORMAT) AS "LOGTIME"
FROM
    QUESTION_ANSWER QA
JOIN
    (
    SELECT CENTER
         , ID
         , SUBID
         , QUESTIONNAIRE_CAMPAIGN_ID
         , LOG_TIME
         , MAX(LOG_TIME) OVER (PARTITION BY CENTER, ID, QUESTIONNAIRE_CAMPAIGN_ID) MAX_LOG_TIME
    FROM QUESTIONNAIRE_ANSWER
    WHERE COMPLETED = 1 
    ) QUN
ON
    QA.ANSWER_CENTER = QUN.CENTER
    AND QA.ANSWER_ID = QUN.ID
    AND QA.ANSWER_SUBID = QUN.SUBID
    AND QUN.LOG_TIME = QUN.MAX_LOG_TIME
	AND QA.NUMBER_ANSWER IS NOT NULL
JOIN
    QUESTIONNAIRE_CAMPAIGNS QC
ON
    QC.ID = QUN.QUESTIONNAIRE_CAMPAIGN_ID
	AND QC.QUESTIONNAIRE IN (401,1801,2001)
JOIN
    PERSONS p
ON
    QUN.CENTER = P.CENTER
    AND QUN.ID = P.ID
    AND p.sex !='C' 
JOIN
    PERSONS cp
ON
    p.CURRENT_PERSON_CENTER = cp.CENTER
    AND p.CURRENT_PERSON_ID = cp.ID
JOIN 
    PARAMS
ON
    params.center = QUN.CENTER	
WHERE
    QUN.CENTER in ($$scope$$)
    AND QUN.LOG_TIME >= params.FROMDATE 
    AND QUN.LOG_TIME < params.TODATE 