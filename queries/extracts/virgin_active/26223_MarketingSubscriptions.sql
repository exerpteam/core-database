 WITH
     params AS
     (
         SELECT
            CASE
                WHEN $$offset$$ = -1
                THEN 0
                ELSE datetolong(TO_CHAR(CURRENT_DATE - interval '1 day'*$$offset$$, 'yyyy-MM-dd HH24:MI'
                    ) )
            END                                                                       AS FROMDATE,
            datetolong(TO_CHAR(CURRENT_DATE + interval '1 day', 'yyyy-MM-dd HH24:MI') ) AS TODATE
     )
 SELECT
 biview."PERSON_ID",
 biview."SUBSCRIPTION_ID",
 biview."SUBSCRIPTION_CENTER",
 biview."STATE",
 biview."SUB_STATE",
 biview."RENEWAL_TYPE",
 biview."PRODUCT_ID",
 biview."START_DATE",
 biview."STOP_DATE",
 biview."END_DATE",
 biview."BILLED_UNTIL_DATE",
 biview."BINDING_END_DATE",
 biview."CREATION_DATE",
 CAST(biview."SUBSCRIPTION_PRICE" AS DECIMAL(15,2))                                                                        AS "SUBSCRIPTION_PRICE",
 CAST(biview."BINDING_PRICE" AS DECIMAL(15,2))                                                                     AS "BINDING_PRICE",
 biview."REQUIRES_MAIN",
 biview."SUB_PRICE_UPDATE_EXCLUDED",
 biview."TYPE_PRICE_UPDATE_EXCLUDED",
 biview."FREEZE_PERIOD_PRODUCT_ID",
 biview."TRANSFERRED_TO",
 biview."EXTENDED_TO",
 biview."PERIOD_UNIT",
 biview."PERIOD_COUNT",
 biview."CENTER_ID",
 p."PRODUCT_GROUP_ID",
 p."MASTER_PRODUCT_ID",
 p."NAME" as "PRODUCT_NAME",
 p."SALES_PRICE" AS "PRODUCT_SALES_PRICE",
 p."MINIMUM_PRICE" AS "PRODUCT_MINIMUM_PRICE",
 p."COST_PRICE" AS "PRODUCT_COST_PRICE"
 FROM
     params,
     ( SELECT cp.external_id AS "PERSON_ID", ((s.center || 'ss'::text) || s.id) AS "SUBSCRIPTION_ID", (s.center)::character varying(255) AS "SUBSCRIPTION_CENTER", bi_decode_field('SUBSCRIPTIONS'::character varying, 'STATE'::character varying, s.state) AS "STATE", bi_decode_field('SUBSCRIPTIONS'::character varying, 'SUB_STATE'::character varying, s.sub_state) AS "SUB_STATE", bi_decode_field('SUBSCRIPTIONTYPES'::character varying, 'ST_TYPE'::character varying, st.st_type) AS "RENEWAL_TYPE", ((s.subscriptiontype_center || 'prod'::text) || s.subscriptiontype_id) AS "PRODUCT_ID", to_char((s.start_date)::timestamp with time zone, 'YYYY-MM-DD'::text) AS "START_DATE", to_char(longtodatec((scstop.stop_change_time)::double precision, (s.center)::double precision), 'YYYY-MM-DD'::text) AS "STOP_DATE", to_char((s.end_date)::timestamp with time zone, 'YYYY-MM-DD'::text) AS "END_DATE", to_char((s.billed_until_date)::timestamp with time zone, 'YYYY-MM-DD'::text) AS "BILLED_UNTIL_DATE", to_char((s.binding_end_date)::timestamp with time zone, 'YYYY-MM-DD'::text) AS "BINDING_END_DATE", to_char(longtodatec((s.creation_time)::double precision, (s.center)::double precision), 'YYYY-MM-DD'::text) AS "CREATION_DATE", CASE WHEN (s.invoiceline_center IS NOT NULL) THEN ((s.invoiceline_center || 'inv'::text) || s.invoiceline_id) ELSE NULL::text END AS "SALE_ID", CASE WHEN (s.invoiceline_center IS NOT NULL) THEN ((((s.invoiceline_center || 'inv'::text) || s.invoiceline_id) || 'ln'::text) || s.invoiceline_subid) ELSE NULL::text END AS "JF_SALE_LOG_ID", s.subscription_price AS "SUBSCRIPTION_PRICE", s.binding_price AS "BINDING_PRICE", CASE WHEN (st.is_addon_subscription = 0) THEN 'FALSE'::text WHEN (st.is_addon_subscription = 1) THEN 'TRUE'::text ELSE NULL::text END AS "REQUIRES_MAIN", CASE WHEN (s.is_price_update_excluded = 0) THEN 'FALSE'::text WHEN (s.is_price_update_excluded = 1) THEN 'TRUE'::text ELSE NULL::text END AS "SUB_PRICE_UPDATE_EXCLUDED", CASE WHEN (st.is_addon_subscription = 0) THEN 'FALSE'::text WHEN (st.is_addon_subscription = 1) THEN 'TRUE'::text ELSE NULL::text END AS "TYPE_PRICE_UPDATE_EXCLUDED", CASE WHEN (st.freezeperiodproduct_center IS NOT NULL) THEN ((st.freezeperiodproduct_center || 'prod'::text) || st.freezeperiodproduct_id) ELSE NULL::text END AS "FREEZE_PERIOD_PRODUCT_ID", CASE WHEN (s.transferred_center IS NOT NULL) THEN ((s.transferred_center || 'ss'::text) || s.transferred_id) ELSE NULL::text END AS "TRANSFERRED_TO", CASE WHEN (s.extended_to_center IS NOT NULL) THEN ((s.extended_to_center || 'ss'::text) || s.extended_to_id) ELSE NULL::text END AS "EXTENDED_TO", CASE WHEN (st.periodunit = 0) THEN 'WEEK'::text WHEN (st.periodunit = 1) THEN 'DAY'::text WHEN (st.periodunit = 2) THEN 'MONTH'::text WHEN (st.periodunit = 3) THEN 'YEAR'::text WHEN (st.periodunit = 4) THEN 'HOUR'::text WHEN (st.periodunit = 5) THEN 'MINUTE'::text WHEN (st.periodunit = 6) THEN 'SECOND'::text ELSE 'UNKNOWN'::text END AS "PERIOD_UNIT", st.periodcount AS "PERIOD_COUNT", CASE WHEN (s.reassigned_center IS NOT NULL) THEN ((s.reassigned_center || 'ss'::text) || s.reassigned_id) ELSE NULL::text END AS "REASIGNED_TO", scstop.stop_person_id AS "STOP_PERSON_ID", to_char(longtodatec((scstop.stop_cancel_time)::double precision, (s.center)::double precision), 'YYYY-MM-DD'::text) AS "STOP_CANCEL_DATE", CASE WHEN (s.payment_agreement_center IS NOT NULL) THEN ((((s.payment_agreement_center || 'ar'::text) || s.payment_agreement_id) || 'agr'::text) || s.payment_agreement_subid) ELSE ''::text END AS "PAYMENT_AGREEMENT_ID", s.center AS "CENTER_ID", s.last_modified AS "ETS" FROM ((((subscriptions s JOIN persons p ON (((p.center = s.owner_center) AND (p.id = s.owner_id)))) JOIN persons cp ON (((cp.center = p.transfers_current_prs_center) AND (cp.id = p.transfers_current_prs_id)))) JOIN subscriptiontypes st ON (((st.center = s.subscriptiontype_center) AND (st.id = s.subscriptiontype_id)))) LEFT JOIN ( SELECT x.old_subscription_center, x.old_subscription_id, x.stop_change_time, x.stop_cancel_time, x.stop_person_id FROM ( SELECT scstop_1.old_subscription_center, scstop_1.old_subscription_id, scstop_1.change_time AS stop_change_time, cp_1.external_id AS stop_person_id, scstop_1.cancel_time AS stop_cancel_time, rank() OVER (PARTITION BY scstop_1.old_subscription_center, scstop_1.old_subscription_id ORDER BY scstop_1.change_time DESC) AS rnk FROM (((subscription_change scstop_1 JOIN employees emp ON (((emp.center = scstop_1.employee_center) AND (emp.id = scstop_1.employee_id)))) JOIN persons p_1 ON (((emp.personcenter = p_1.center) AND (emp.personid = p_1.id)))) JOIN persons cp_1 ON (((cp_1.center = p_1.transfers_current_prs_center) AND (cp_1.id = p_1.transfers_current_prs_id)))) WHERE ((scstop_1.type)::text = 'END_DATE'::text)) x WHERE (x.rnk = 1)) scstop ON (((scstop.old_subscription_center = s.center) AND (scstop.old_subscription_id = s.id)))) ) biview
 INNER JOIN 

( SELECT ((p.center || 'prod'::text) || p.id) AS "PRODUCT_ID", (p.center)::character varying(255) AS "PRODUCT_CENTER", (mp.id)::character varying(255) AS "MASTER_PRODUCT_ID", (p.primary_product_group_id)::character varying(255) AS "PRODUCT_GROUP_ID", p.name AS "NAME", bi_decode_field('PRODUCTS'::character varying, 'PTYPE'::character varying, p.ptype) AS "PRODUCT_TYPE", p.external_id AS "EXTERNAL_ID", p.price AS "SALES_PRICE", p.min_price AS "MINIMUM_PRICE", p.cost_price AS "COST_PRICE", CASE WHEN (p.blocked = 0) THEN 'FALSE'::text WHEN (p.blocked = 1) THEN 'TRUE'::text ELSE NULL::text END AS "BLOCKED", p.sales_commission AS "SALES_COMMISSION", p.sales_units AS "SALES_UNITS", p.period_commission AS "PERIOD_COMMISSION", CASE WHEN ((max(pg.exclude_from_member_count) = 0) AND (p.ptype = 10)) THEN 'TRUE'::text ELSE 'FALSE'::text END AS "INCLUDED_MEMBER_COUNT", p.center AS "CENTER_ID", p.last_modified AS "ETS", p.flat_rate_commission AS "FLAT_RATE_COMMISSION" FROM (((products p LEFT JOIN masterproductregister mp ON (((mp.id = mp.definition_key) AND ((p.globalid)::text = (mp.globalid)::text)))) LEFT JOIN product_and_product_group_link ppgl ON (((ppgl.product_center = p.center) AND (ppgl.product_id = p.id)))) LEFT JOIN product_group pg ON ((pg.id = ppgl.product_group_id))) WHERE (p.ptype <> ALL (ARRAY[5, 6, 7, 12])) GROUP BY ((p.center || 'prod'::text) || p.id), p.center, mp.id, p.primary_product_group_id, p.name, p.ptype, p.external_id, p.price, p.min_price, p.cost_price, CASE WHEN (p.blocked = 0) THEN 'FALSE'::text WHEN (p.blocked = 1) THEN 'TRUE'::text ELSE NULL::text END, p.sales_commission, p.sales_units, p.period_commission, p.last_modified, p.flat_rate_commission UNION ALL SELECT ((p.center || 'prod'::text) || p.id) AS "PRODUCT_ID", (p.center)::character varying(255) AS "PRODUCT_CENTER", (mp.id)::character varying(255) AS "MASTER_PRODUCT_ID", (p.primary_product_group_id)::character varying(255) AS "PRODUCT_GROUP_ID", p.name AS "NAME", bi_decode_field('PRODUCTS'::character varying, 'PTYPE'::character varying, p.ptype) AS "PRODUCT_TYPE", spr.external_id AS "EXTERNAL_ID", p.price AS "SALES_PRICE", p.min_price AS "MINIMUM_PRICE", p.cost_price AS "COST_PRICE", CASE WHEN (p.blocked = 0) THEN 'FALSE'::text WHEN (p.blocked = 1) THEN 'TRUE'::text ELSE NULL::text END AS "BLOCKED", p.sales_commission AS "SALES_COMMISSION", p.sales_units AS "SALES_UNITS", p.period_commission AS "PERIOD_COMMISSION", 'FALSE'::text AS "INCLUDED_MEMBER_COUNT", p.center AS "CENTER_ID", p.last_modified AS "ETS", p.flat_rate_commission AS "FLAT_RATE_COMMISSION" FROM (((products p LEFT JOIN subscriptiontypes st ON (((st.productnew_center = p.center) AND (st.productnew_id = p.id)))) LEFT JOIN products spr ON (((spr.center = st.center) AND (spr.id = st.id)))) LEFT JOIN masterproductregister mp ON (((mp.id = mp.definition_key) AND ((spr.globalid)::text = (mp.globalid)::text)))) WHERE (p.ptype = 5) UNION ALL SELECT ((p.center || 'prod'::text) || p.id) AS "PRODUCT_ID", (p.center)::character varying(255) AS "PRODUCT_CENTER", (mp.id)::character varying(255) AS "MASTER_PRODUCT_ID", (p.primary_product_group_id)::character varying(255) AS "PRODUCT_GROUP_ID", p.name AS "NAME", bi_decode_field('PRODUCTS'::character varying, 'PTYPE'::character varying, p.ptype) AS "PRODUCT_TYPE", spr.external_id AS "EXTERNAL_ID", p.price AS "SALES_PRICE", p.min_price AS "MINIMUM_PRICE", p.cost_price AS "COST_PRICE", CASE WHEN (p.blocked = 0) THEN 'FALSE'::text WHEN (p.blocked = 1) THEN 'TRUE'::text ELSE NULL::text END AS "BLOCKED", p.sales_commission AS "SALES_COMMISSION", p.sales_units AS "SALES_UNITS", p.period_commission AS "PERIOD_COMMISSION", 'FALSE'::text AS "INCLUDED_MEMBER_COUNT", p.center AS "CENTER_ID", p.last_modified AS "ETS", p.flat_rate_commission AS "FLAT_RATE_COMMISSION" FROM (((products p LEFT JOIN subscriptiontypes st ON (((st.freezeperiodproduct_center = p.center) AND (st.freezeperiodproduct_id = p.id)))) LEFT JOIN products spr ON (((spr.center = st.center) AND (spr.id = st.id)))) LEFT JOIN masterproductregister mp ON (((mp.id = mp.definition_key) AND ((spr.globalid)::text = (mp.globalid)::text)))) WHERE (p.ptype = 7) UNION ALL SELECT ((p.center || 'prod'::text) || p.id) AS "PRODUCT_ID", (p.center)::character varying(255) AS "PRODUCT_CENTER", (mp.id)::character varying(255) AS "MASTER_PRODUCT_ID", (p.primary_product_group_id)::character varying(255) AS "PRODUCT_GROUP_ID", p.name AS "NAME", bi_decode_field('PRODUCTS'::character varying, 'PTYPE'::character varying, p.ptype) AS "PRODUCT_TYPE", spr.external_id AS "EXTERNAL_ID", p.price AS "SALES_PRICE", p.min_price AS "MINIMUM_PRICE", p.cost_price AS "COST_PRICE", CASE WHEN (p.blocked = 0) THEN 'FALSE'::text WHEN (p.blocked = 1) THEN 'TRUE'::text ELSE NULL::text END AS "BLOCKED", p.sales_commission AS "SALES_COMMISSION", p.sales_units AS "SALES_UNITS", p.period_commission AS "PERIOD_COMMISSION", 'FALSE'::text AS "INCLUDED_MEMBER_COUNT", p.center AS "CENTER_ID", p.last_modified AS "ETS", p.flat_rate_commission AS "FLAT_RATE_COMMISSION" FROM (((products p LEFT JOIN subscriptiontypes st ON (((st.prorataproduct_center = p.center) AND (st.prorataproduct_id = p.id)))) LEFT JOIN products spr ON (((spr.center = st.center) AND (spr.id = st.id)))) LEFT JOIN masterproductregister mp ON (((mp.id = mp.definition_key) AND ((spr.globalid)::text = (mp.globalid)::text)))) WHERE (p.ptype = 12) UNION ALL SELECT ((p.center || 'prod'::text) || p.id) AS "PRODUCT_ID", (p.center)::character varying(255) AS "PRODUCT_CENTER", (mp.id)::character varying(255) AS "MASTER_PRODUCT_ID", (p.primary_product_group_id)::character varying(255) AS "PRODUCT_GROUP_ID", p.name AS "NAME", bi_decode_field('PRODUCTS'::character varying, 'PTYPE'::character varying, p.ptype) AS "PRODUCT_TYPE", spr.external_id AS "EXTERNAL_ID", p.price AS "SALES_PRICE", p.min_price AS "MINIMUM_PRICE", p.cost_price AS "COST_PRICE", CASE WHEN (p.blocked = 0) THEN 'FALSE'::text WHEN (p.blocked = 1) THEN 'TRUE'::text ELSE NULL::text END AS "BLOCKED", p.sales_commission AS "SALES_COMMISSION", p.sales_units AS "SALES_UNITS", p.period_commission AS "PERIOD_COMMISSION", 'FALSE'::text AS "INCLUDED_MEMBER_COUNT", p.center AS "CENTER_ID", p.last_modified AS "ETS", p.flat_rate_commission AS "FLAT_RATE_COMMISSION" FROM (((products p LEFT JOIN subscriptiontypes st ON (((st.transferproduct_center = p.center) AND (st.transferproduct_id = p.id)))) LEFT JOIN products spr ON (((spr.center = st.center) AND (spr.id = st.id)))) LEFT JOIN masterproductregister mp ON (((mp.id = mp.definition_key) AND ((spr.globalid)::text = (mp.globalid)::text)))) WHERE (p.ptype = 6) ) p

         ON p."PRODUCT_ID" = biview."PRODUCT_ID"
 WHERE
     biview."ETS" BETWEEN PARAMS.FROMDATE AND PARAMS.TODATE
     and biview."CENTER_ID" in ($$scope$$)
