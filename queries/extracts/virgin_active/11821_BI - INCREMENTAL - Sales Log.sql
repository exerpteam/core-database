 WITH
     params AS Materialized
     (
         SELECT
             CAST(datetolongtz(TO_CHAR(CURRENT_DATE, 'yyyy-MM-dd HH24:MI' ),'Europe/London' ) - 1000*60*60*24*5
            AS bigint) AS FROMDATE,
            CAST(datetolongtz(TO_CHAR(CURRENT_DATE, 'yyyy-MM-dd HH24:MI'),'Europe/London' ) + 1000*60*60*24 AS bigint)
            AS TODATE
     )
 SELECT
     sl.*
 FROM
     ( SELECT x."SALES_LINE_ID", x."CENTER_ID", x."SALES_TYPE", x."PERSON_ID", x."COMPANY_ID", x."IS_COMPANY", x."SALES_PERSON_ID", x."ENTRY_DATE_TIME", x."BOOK_DATE_TIME", x."PRODUCT_CENTER", x."PRODUCT_ID", x."PRODUCT_TYPE", x."PRODUCT_NORMAL_PRICE", x."QUANTITY", x."NET_AMOUNT", x."VAT_AMOUNT", x."TOTAL_AMOUNT", x."SPONSOR_LINE_ID", x."GL_DEBIT_ACCOUNT", x."GL_CREDIT_ACCOUNT", x."SALES_COMMISSION", x."SALES_UNITS", x."PERIOD_COMMISSION", x."SOURCE_TYPE", x."SALES_LOG_ID_CREDITED", x."SALE_ID", x."CASH_REGISTER_CENTER_ID", x."TTS", x."ETS", x."FLAT_RATE_COMMISSION", x."EXTERNAL_ID", x."PAYER_PERSON_ID" FROM ( SELECT ((((il.center || 'inv'::text) || il.id) || 'ln'::text) || il.subid) AS "SALES_LINE_ID", il.center AS "CENTER_ID", 'INVOICE'::text AS "SALES_TYPE", CASE WHEN ((p.sex)::text <> 'C'::text) THEN cp.external_id ELSE NULL::character varying END AS "PERSON_ID", CASE WHEN ((cpayer.sex)::text = 'C'::text) THEN cpayer.external_id ELSE NULL::character varying END AS "COMPANY_ID", CASE WHEN ((cpayer.sex)::text = 'C'::text) THEN 'TRUE'::text ELSE 'FALSE'::text END AS "IS_COMPANY", csales_person.external_id AS "SALES_PERSON_ID", to_char(longtodatec((i.entry_time)::double precision, (i.center)::double precision), 'YYYY-MM-DD HH24:MI:SS'::text) AS "ENTRY_DATE_TIME", to_char(longtodatec((i.trans_time)::double precision, (i.center)::double precision), 'YYYY-MM-DD HH24:MI:SS'::text) AS "BOOK_DATE_TIME", prod.center AS "PRODUCT_CENTER", ((prod.center || 'prod'::text) || prod.id) AS "PRODUCT_ID", bi_decode_field('PRODUCTS'::character varying, 'PTYPE'::character varying, prod.ptype) AS "PRODUCT_TYPE", il.product_normal_price AS "PRODUCT_NORMAL_PRICE", il.quantity AS "QUANTITY", round(il.net_amount, 2) AS "NET_AMOUNT", (round(il.total_amount, 2) - round(il.net_amount, 2)) AS "VAT_AMOUNT", round(il.total_amount, 2) AS "TOTAL_AMOUNT", CASE WHEN (il.sponsor_invoice_subid IS NOT NULL) THEN ((((i.sponsor_invoice_center || 'inv'::text) || i.sponsor_invoice_id) || 'ln'::text) || il.sponsor_invoice_subid) ELSE NULL::text END AS "SPONSOR_LINE_ID", debitacc.external_id AS "GL_DEBIT_ACCOUNT", credacc.external_id AS "GL_CREDIT_ACCOUNT", il.sales_commission AS "SALES_COMMISSION", il.sales_units AS "SALES_UNITS", il.period_commission AS "PERIOD_COMMISSION", COALESCE(crg.type, 'OTHER'::character varying) AS "SOURCE_TYPE", NULL::text AS "SALES_LOG_ID_CREDITED", ((il.center || 'inv'::text) || il.id) AS "SALE_ID", (crg.center)::character varying(255) AS "CASH_REGISTER_CENTER_ID", i.trans_time AS "TTS", i.entry_time AS "ETS", il.flat_rate_commission AS "FLAT_RATE_COMMISSION", il.external_id AS "EXTERNAL_ID", CASE WHEN ((cpayer.sex)::text <> 'C'::text) THEN cpayer.external_id ELSE NULL::character varying END AS "PAYER_PERSON_ID" FROM ((((((((((((((invoice_lines_mt il JOIN invoices i ON (((il.center = i.center) AND (il.id = i.id)))) JOIN products prod ON (((prod.center = il.productcenter) AND (prod.id = il.productid)))) JOIN account_trans act ON (((act.center = il.account_trans_center) AND (act.id = il.account_trans_id) AND (act.subid = il.account_trans_subid)))) JOIN accounts credacc ON (((act.credit_accountcenter = credacc.center) AND (act.credit_accountid = credacc.id)))) JOIN accounts debitacc ON (((act.debit_accountcenter = debitacc.center) AND (act.debit_accountid = debitacc.id)))) LEFT JOIN product_group pg ON ((pg.id = prod.primary_product_group_id))) LEFT JOIN persons p ON (((p.center = il.person_center) AND (p.id = il.person_id)))) LEFT JOIN persons cp ON (((cp.center = p.transfers_current_prs_center) AND (cp.id = p.transfers_current_prs_id)))) LEFT JOIN employees staff ON (((staff.center = i.employee_center) AND (staff.id = i.employee_id)))) LEFT JOIN persons sales_person ON (((sales_person.center = staff.personcenter) AND (sales_person.id = staff.personid)))) LEFT JOIN persons csales_person ON (((csales_person.center = sales_person.transfers_current_prs_center) AND (csales_person.id = sales_person.transfers_current_prs_id)))) LEFT JOIN cashregisters crg ON (((crg.center = i.cashregister_center) AND (crg.id = i.cashregister_id)))) LEFT JOIN persons payer ON (((payer.center = i.payer_center) AND (payer.id = i.payer_id)))) LEFT JOIN persons cpayer ON (((cpayer.center = payer.transfers_current_prs_center) AND (cpayer.id = payer.transfers_current_prs_id)))) UNION ALL SELECT ((((cl.center || 'cred'::text) || cl.id) || 'cnl'::text) || cl.subid) AS "SALES_LINE_ID", cl.center AS "CENTER_ID", 'CREDIT_NOTE'::text AS "SALES_TYPE", CASE WHEN ((cp.sex)::text <> 'C'::text) THEN cp.external_id ELSE NULL::character varying END AS "PERSON_ID", CASE WHEN ((cpayer.sex)::text = 'C'::text) THEN cpayer.external_id ELSE NULL::character varying END AS "COMPANY_ID", CASE WHEN ((cpayer.sex)::text = 'C'::text) THEN 'TRUE'::text ELSE 'FALSE'::text END AS "IS_COMPANY", csales_person.external_id AS "SALES_PERSON_ID", to_char(longtodatec((c.entry_time)::double precision, (c.center)::double precision), 'YYYY-MM-DD HH24:MI:SS'::text) AS "ENTRY_DATE_TIME", to_char(longtodatec((c.trans_time)::double precision, (c.center)::double precision), 'YYYY-MM-DD HH24:MI:SS'::text) AS "BOOK_DATE_TIME", prod.center AS "PRODUCT_CENTER", ((prod.center || 'prod'::text) || prod.id) AS "PRODUCT_ID", bi_decode_field('PRODUCTS'::character varying, 'PTYPE'::character varying, prod.ptype) AS "PRODUCT_TYPE", NULL::numeric, (- cl.quantity) AS "QUANTITY", (- round(cl.net_amount, 2)) AS "NET_AMOUNT", ((- round(cl.total_amount, 2)) + round(cl.net_amount, 2)) AS "VAT_AMOUNT", (- round(cl.total_amount, 2)) AS "TOTAL_AMOUNT", NULL::text, debitacc.external_id AS "GL_DEBIT_ACCOUNT", credacc.external_id AS "GL_CREDIT_ACCOUNT", cl.sales_commission AS "SALES_COMMISSION", cl.sales_units AS "SALES_UNITS", cl.period_commission AS "PERIOD_COMMISSION", COALESCE(crg.type, 'OTHER'::character varying) AS "SOURCE_TYPE", ((((cl.invoiceline_center || 'inv'::text) || cl.invoiceline_id) || 'ln'::text) || cl.invoiceline_subid) AS "SALES_LOG_ID_CREDITED", ((cl.center || 'cred'::text) || cl.id) AS "SALE_ID", (crg.center)::character varying(255) AS "CASH_REGISTER_CENTER_ID", c.trans_time AS "TST", c.entry_time AS "EST", cl.flat_rate_commission AS "FLAT_RATE_COMMISSION", NULL::character varying AS "EXTERNAL_ID", CASE WHEN ((cpayer.sex)::text <> 'C'::text) THEN cpayer.external_id ELSE NULL::character varying END AS "PAYER_PERSON_ID" FROM ((((((((((((((credit_notes c JOIN credit_note_lines_mt cl ON (((cl.center = c.center) AND (cl.id = c.id)))) JOIN products prod ON (((prod.center = cl.productcenter) AND (prod.id = cl.productid)))) JOIN account_trans act ON (((act.center = cl.account_trans_center) AND (act.id = cl.account_trans_id) AND (act.subid = cl.account_trans_subid)))) JOIN accounts credacc ON (((act.credit_accountcenter = credacc.center) AND (act.credit_accountid = credacc.id)))) JOIN accounts debitacc ON (((act.debit_accountcenter = debitacc.center) AND (act.debit_accountid = debitacc.id)))) LEFT JOIN product_group pg ON ((pg.id = prod.primary_product_group_id))) LEFT JOIN persons p ON (((p.center = cl.person_center) AND (p.id = cl.person_id)))) LEFT JOIN persons cp ON (((cp.center = p.transfers_current_prs_center) AND (cp.id = p.transfers_current_prs_id)))) LEFT JOIN employees staff ON (((staff.center = c.employee_center) AND (staff.id = c.employee_id)))) LEFT JOIN persons sales_person ON (((sales_person.center = staff.personcenter) AND (sales_person.id = staff.personid)))) LEFT JOIN persons csales_person ON (((csales_person.center = sales_person.transfers_current_prs_center) AND (csales_person.id = sales_person.transfers_current_prs_id)))) LEFT JOIN cashregisters crg ON (((crg.center = c.cashregister_center) AND (crg.id = c.cashregister_id)))) LEFT JOIN persons payer ON (((payer.center = c.payer_center) AND (payer.id = c.payer_id)))) LEFT JOIN persons cpayer ON (((cpayer.center = payer.transfers_current_prs_center) AND (cpayer.id = payer.transfers_current_prs_id))))) x ) sl
, params
 WHERE
     sl."ETS" >= PARAMS.FROMDATE
     AND sl."ETS" < PARAMS.TODATE
and sl."CENTER_ID" in ($$scope$$)