SELECT
    i4.*,
    (0 - i4.selina_over_18 - i4.exerp_over_18) diff,
    (0 + current_balance - selina_total - exerp_total - balance_pro_selina) diff2
FROM
    (
        SELECT
            i3.payer,
            SUM(i3.balance_before_selina) balance_pro_selina,
            SUM(
                CASE
                    WHEN i3.age IN (0,-1)
                        /* 18 or over */
                    THEN i3.selina_transactions
                    ELSE 0
                END) selina_over_18,
            SUM(
                CASE
                    WHEN i3.age IN (1)
                        /* under 18 */
                    THEN i3.selina_transactions
                    ELSE 0
                END)                    seline_under_18,
            SUM(i3.selina_transactions) selina_total,
            SUM(
                CASE
                    WHEN i3.age IN (0,-1)
                        /* 18 or over */
                    THEN i3.exerp_transactions
                    ELSE 0
                END) exerp_over_18,
            SUM(
                CASE
                    WHEN i3.age IN (1)
                        /* under 18 */
                    THEN i3.exerp_transactions
                    ELSE 0
                END)                   exerp_under_18,
            SUM(i3.exerp_transactions) exerp_total,
            SUM(i3.current_balance)    current_balance
        FROM
            (
                SELECT
                    /*
                    sum(CASE
                    WHEN cnl.TOTAL_AMOUNT is not null
                    THEN cnl.TOTAL_AMOUNT
                    WHEN invl.TOTAL_AMOUNT is not null
                    THEN invl.TOTAL_AMOUNT * -1
                    ELSE art.AMOUNT
                    END) AS balance_before_selina
                    */
                    i2.CUSTOMERCENTER || 'p' || i2.CUSTOMERID payer,
                    --    i2.first_day,
                    --    i2.last_day,
                    --    cn.CENTER,
                    --    inv.CENTER,
                    --    art.*
                    --    art.EMPLOYEECENTER,
                    --    art.EMPLOYEEID,
                    --    exerpro.longtodate(art.TRANS_TIME),
                    CASE
                        WHEN cnl.TOTAL_AMOUNT IS NOT NULL
                        THEN SIGN(18 - floor(months_between(SYSDATE,cp.BIRTHDATE)/12) )
                        WHEN invl.TOTAL_AMOUNT IS NOT NULL
                        THEN SIGN(18 - floor(months_between(SYSDATE,ip.BIRTHDATE)/12) )
                        ELSE SIGN(18 - floor(months_between(SYSDATE,i2.BIRTHDATE)/12) )
                    END age,
                    SUM(
                        CASE
                            WHEN art.TRANS_TIME < exerpro.dateToLong(TO_CHAR(i2.first_day,'YYYY-MM-DD HH24:MI'))
                            THEN
                                CASE
                                    WHEN cnl.TOTAL_AMOUNT IS NOT NULL
                                    THEN cnl.TOTAL_AMOUNT
                                    WHEN invl.TOTAL_AMOUNT IS NOT NULL
                                    THEN invl.TOTAL_AMOUNT * -1
                                    ELSE art.AMOUNT
                                END
                            ELSE 0
                        END) AS balance_before_selina ,
                    SUM(
                        CASE
                            WHEN art.TRANS_TIME BETWEEN exerpro.dateToLong(TO_CHAR(i2.first_day,'YYYY-MM-DD HH24:MI')) AND exerpro.dateToLong(TO_CHAR(i2.last_day,'YYYY-MM-DD HH24:MI'))
                            THEN
                                CASE
                                    WHEN cnl.TOTAL_AMOUNT IS NOT NULL
                                    THEN cnl.TOTAL_AMOUNT
                                    WHEN invl.TOTAL_AMOUNT IS NOT NULL
                                    THEN invl.TOTAL_AMOUNT * -1
                                    ELSE art.AMOUNT
                                END
                            ELSE 0
                        END) AS selina_transactions,
                    SUM(
                        CASE
                            WHEN art.EMPLOYEECENTER = 100
                                AND art.EMPLOYEEID = 1002
                                AND art.TRANS_TIME > exerpro.dateToLong(TO_CHAR(i2.last_day,'YYYY-MM-DD HH24:MI'))
                            THEN
                                CASE
                                    WHEN cnl.TOTAL_AMOUNT IS NOT NULL
                                    THEN cnl.TOTAL_AMOUNT
                                    WHEN invl.TOTAL_AMOUNT IS NOT NULL
                                    THEN invl.TOTAL_AMOUNT * -1
                                    ELSE art.AMOUNT
                                END
                            ELSE 0
                        END) AS exerp_transactions,
                    SUM(
                        CASE
                            WHEN cnl.TOTAL_AMOUNT IS NOT NULL
                            THEN cnl.TOTAL_AMOUNT
                            WHEN invl.TOTAL_AMOUNT IS NOT NULL
                            THEN invl.TOTAL_AMOUNT * -1
                            ELSE art.AMOUNT
                        END) current_balance
                FROM
                    (
                        SELECT DISTINCT
                            ar.CENTER,
                            ar.ID,
                            ar.CUSTOMERCENTER,
                            ar.CUSTOMERID ,
                            p.BIRTHDATE,
                            TRUNC(least(NVL(exerpro.longtodate(je.CREATION_TIME),to_date('2020-01-01','YYYY-MM-DD')),NVL(i1.first_entry,to_date('2020-01-01','YYYY-MM-DD'))))     first_day,
                            TRUNC(greatest(NVL(exerpro.longtodate(je.CREATION_TIME),to_date('1980-01-01','YYYY-MM-DD')),NVL(i1.last_entry,to_date('1980-01-01','YYYY-MM-DD'))))+1 last_day
                        FROM
                            ACCOUNT_RECEIVABLES ar
                        JOIN
                            PERSONS p
                        ON
                            p.CENTER = ar.CUSTOMERCENTER
                            AND p.ID = ar.CUSTOMERID
                        LEFT JOIN
                            JOURNALENTRIES je
                        ON
                            je.PERSON_CENTER = ar.CUSTOMERCENTER
                            AND je.PERSON_ID = ar.CUSTOMERID
                            AND je.NAME = 'Stop'
                            AND je.CREATORCENTER = 4
                            AND je.CREATORID = 834
                        LEFT JOIN
                            (
                                SELECT
                                    exerpro.longtodate(MIN(je.CREATION_TIME)) first_entry,
                                    exerpro.longtodate(MAX(je.CREATION_TIME)) last_entry,
                                    rel.CENTER,
                                    rel.ID
                                FROM
                                    RELATIVES rel
                                JOIN
                                    JOURNALENTRIES je
                                ON
                                    ((
                                            je.PERSON_CENTER = rel.CENTER
                                            AND je.PERSON_ID = rel.id)
                                        OR (
                                            je.PERSON_CENTER = rel.RELATIVECENTER
                                            AND je.PERSON_ID = rel.RELATIVEID) )
                                    AND je.NAME = 'Stop'
                                    AND je.CREATORCENTER = 4
                                    AND je.CREATORID = 834
                                WHERE
                                    rel.RTYPE = 12
                                    AND rel.STATUS = 1
                                GROUP BY
                                    rel.CENTER,
                                    rel.ID ) i1
                        ON
                            i1.center = CUSTOMERCENTER
                            AND i1.ID = CUSTOMERID
                        WHERE
                            (
                                ar.CUSTOMERCENTER, ar.CUSTOMERID) IN (
(402,1159),
(402,1211),
(402,1230),
(402,1319),
(402,1337),
(402,1468),
(402,1468),
(402,1983),
(402,2037),
(402,2037),
(402,2165),
(402,2380),
(402,2462),
(402,2792),
(402,2165),
(402,2959),
(402,3153),
(402,3351),
(402,3359),
(402,2792),
(402,3558),
(402,3559),
(402,3560),
(402,3745),
(402,3745),
(402,734),
(402,4180),
(402,4325),
(402,4399),
(402,4548),
(402,4562),
(402,4627),
(402,4918),
(402,5046),
(406,790),
(406,839),
(406,1225),
(406,839),
(406,1382),
(406,1639),
(406,251),
(406,2061),
(406,2263),
(406,2438),
(406,2497),
(406,342),
(406,2825),
(406,2991),
(406,342),
(406,3097),
(406,3201),
(406,404),
(406,3271),
(406,3881),
(406,3959),
(406,4086),
(406,4328),
(406,112),
(406,4460),
(406,4460),
(406,4694),
(406,4754),
(406,4792),
(406,563),
(406,5084),
(406,587),
(408,1363),
(408,208),
(408,1860),
(408,2309),
(408,2445),
(408,2457),
(408,320),
(408,2723),
(408,2884),
(408,3059),
(408,3320),
(408,114),
(408,391),
(408,495),
(414,7421),
(414,973),
(414,1720),
(414,2614),
(414,2614),
(414,2938),
(414,529),
(414,512),
(414,529),
(414,3481),
(414,4129),
(414,659),
(414,6821),
(415,1317),
(415,1400),
(415,1435),
(415,1575),
(415,1585),
(415,1767),
(415,1837),
(415,2401),
(415,2453),
(415,2688),
(415,2401),
(415,3056),
(415,525),
(415,3595),
(415,3644),
(415,4080),
(415,4250),
(415,4896),
(417,769),
(417,964),
(417,1059),
(417,1129),
(417,1134),
(417,1181),
(417,1181),
(417,1398),
(417,1441),
(417,1471),
(417,1478),
(417,1518),
(417,1548),
(417,1553),
(417,1720),
(417,1763),
(417,1775),
(417,1846),
(417,2039),
(417,2052),
(417,324),
(417,617),
(417,109),
(417,700),
(417,706),
(418,1123),
(418,1556),
(418,1613),
(418,1843),
(418,1923),
(418,2286),
(418,359),
(418,461),
(418,566),
(418,109),
(418,119),
(422,728),
(422,853),
(422,1031),
(422,1063),
(422,1096),
(422,1101),
(422,1183),
(422,1205),
(422,1525),
(422,1542),
(422,1693),
(422,1704),
(422,1755),
(422,1781),
(422,244),
(422,2034),
(422,264),
(422,291),
(422,2654),
(422,310),
(422,2752),
(422,2760),
(422,2760),
(422,553),
(422,106),
(422,728),
(425,1022),
(425,1161),
(425,1314),
(425,1572),
(425,1585),
(425,1623),
(425,2132),
(425,263),
(425,2154),
(425,2236),
(425,2814),
(425,1124),
(425,3086),
(425,3086),
(425,3103),
(425,3277),
(425,3278),
(425,419),
(425,454),
(425,648),
(425,654),
(425,675),
(425,736),
(429,1508),
(429,1508),
(429,1612),
(429,1618),
(429,1627),
(429,1651),
(429,1683),
(429,1738),
(429,2063),
(429,2173),
(429,2180),
(429,2274),
(429,2291),
(429,1618),
(429,2335),
(429,2654),
(429,2694),
(429,2335),
(429,2935),
(429,856),
(429,857),
(429,3421),
(429,3532),
(429,3647),
(429,3733),
(429,916),
(429,1044),
(429,1150),
(430,748),
(430,755),
(430,764),
(430,790),
(430,869),
(430,1309),
(430,1409),
(430,1409),
(430,1864),
(430,2048),
(430,80),
(430,2561),
(430,2659),
(430,2690),
(430,2690),
(430,2767),
(430,2797),
(430,2871),
(430,2876),
(430,2935),
(430,496),
(430,581),
(436,1142),
(436,1142),
(436,139),
(436,1445),
(436,1445),
(436,1445),
(436,1837),
(436,2241),
(436,2241),
(436,2446),
(436,2947),
(436,3029),
(436,344),
(436,3467),
(436,367),
(436,3562),
(436,3571),
(436,3670),
(436,3744),
(436,4139),
(436,4638),
(436,4735),
(436,4929),
(436,4956),
(439,842),
(439,852),
(439,878),
(439,893),
(439,936),
(439,173),
(439,1308),
(439,1473),
(439,1476),
(439,1544),
(439,1643),
(439,1643),
(439,223),
(439,2024),
(439,893),
(439,2240),
(439,2560),
(439,2560),
(439,2663),
(439,2956),
(439,2962),
(439,2962),
(439,2980),
(439,3174),
(439,3218),
(439,3307),
(439,3479),
(439,3617),
(439,418),
(439,3714),
(439,103),
(439,3880),
(439,3714),
(439,4066),
(439,4090),
(439,852),
(439,4273),
(439,4988),
(439,5035),
(439,5055),
(439,567),
(439,5155),
(439,5174),
(439,5193),
(439,5211),
(439,585),
(439,645),
(440,765),
(440,1117),
(440,1117),
(440,1256),
(440,1259),
(440,1537),
(440,1547),
(440,196),
(440,1811),
(440,1899),
(440,1901),
(440,1941),
(440,1955),
(440,2027),
(440,249),
(440,256),
(440,261),
(440,2294),
(440,2295),
(440,2300),
(440,2310),
(440,2523),
(440,2612),
(440,2635),
(440,2690),
(440,2846),
(440,2846),
(440,2872),
(440,2815),
(440,2889),
(440,2890),
(440,3288),
(440,394),
(440,3689),
(440,3889),
(440,3977),
(440,4147),
(440,4301),
(440,4326),
(440,4606),
(440,4643),
(440,4650),
(440,4722),
(440,4804),
(440,4872),
(440,541),
(440,5196),
(440,5197),
(440,5326),
(440,732),
(444,981),
(444,139),
(444,1066),
(444,1110),
(444,1148),
(444,1163),
(444,1177),
(444,1218),
(444,170),
(444,1352),
(444,1389),
(444,1402),
(444,1425),
(444,1454),
(444,1506),
(444,1558),
(444,1663),
(444,1668),
(444,211),
(444,1806),
(444,1885),
(444,1947),
(444,1998),
(444,1998),
(444,2019),
(444,234),
(444,2253),
(444,2289),
(444,2325),
(444,2432),
(444,2432),
(444,2592),
(444,2602),
(444,2731),
(444,2787),
(444,2846),
(444,2901),
(444,2903),
(444,2942),
(444,3002),
(444,3007),
(444,3050),
(444,3063),
(444,331),
(444,3082),
(444,335),
(444,370),
(444,437),
(444,437),
(444,91),
(444,647),
(444,680),
(444,698),
(446,853),
(446,944),
(446,125),
(446,1008),
(446,1216),
(446,1227),
(446,49),
(446,1290),
(446,1351),
(446,1391),
(446,1479),
(446,1496),
(446,1550),
(446,1596),
(446,1640),
(446,1816),
(446,1995),
(446,2004),
(446,2155),
(446,241),
(446,2309),
(446,2359),
(446,2359),
(446,2392),
(446,2423),
(446,2520),
(446,2640),
(446,2653),
(446,2703),
(446,73),
(446,431),
(446,450),
(446,488),
(446,533),
(446,654),
(446,674),
(446,685),
(446,725),
(447,981),
(447,1161),
(447,1216),
(447,1241),
(447,1469),
(447,1489),
(447,1711),
(447,1795),
(447,1820),
(447,265),
(447,265),
(447,2002),
(447,2019),
(447,281),
(447,2175),
(447,308),
(447,2382),
(447,2389),
(447,2410),
(447,2431),
(447,324),
(447,2533),
(447,2565),
(447,2626),
(447,341),
(447,2676),
(447,369),
(447,426),
(447,444),
(447,582),
(447,628),
(447,700),
(450,849),
(450,1003),
(450,1361),
(450,211),
(450,1770),
(450,2018),
(450,2019),
(450,2249),
(450,1003),
(450,2296),
(450,2298),
(450,2427),
(450,2682),
(450,357),
(450,94),
(450,421),
(450,477),
(450,667),
(450,667),
(450,778),
(451,1220),
(451,1387),
(451,1417),
(451,1421),
(451,1440),
(451,1641),
(451,1749),
(451,1842),
(451,554),
(451,2087),
(451,2181),
(451,2214),
(451,2221),
(451,2231),
(451,2305),
(451,2335),
(451,2365),
(451,2374),
(451,2377),
(451,603),
(451,2443),
(451,2484),
(451,2518),
(451,2518),
(451,2528),
(451,2655),
(451,2776),
(451,2812),
(451,2776),
(451,3028),
(451,3076),
(451,678),
(451,687),
(451,3270),
(451,3294),
(451,3358),
(451,3554),
(451,3575),
(451,3631),
(451,3638),
(451,3822),
(451,3831),
(451,3881),
(451,848),
(451,912),
(451,939),
(451,1022),
(451,1086),
(451,1106),
(452,1016),
(452,1165),
(452,1165),
(452,162),
(452,1327),
(452,1330),
(452,1375),
(452,1398),
(452,1515),
(452,1561),
(452,1562),
(452,1565),
(452,50),
(452,1597),
(452,1700),
(452,1771),
(452,1860),
(452,223),
(452,1978),
(452,230),
(452,2019),
(452,2078),
(452,2082),
(452,2089),
(452,2134),
(452,2150),
(452,2215),
(452,2225),
(452,249),
(452,2408),
(452,272),
(452,2491),
(452,2570),
(452,2759),
(452,2825),
(452,2831),
(452,2842),
(452,2881),
(452,422),
(452,426),
(452,427),
(452,504),
(452,542),
(452,544),
(452,577),
(452,702),
(452,789),
(452,115),

(401,1400),
(401,1446),
(401,1604),
(401,1643),
(401,1747),
(401,1831),
(401,1954),
(401,2010),
(401,2130),
(401,2152),
(401,2212),
(401,2214),
(401,778),
(401,2276),
(401,2277),
(401,796),
(401,796),
(401,2668),
(401,2669),
(401,2854),
(401,836),
(401,2875),
(401,2921),
(401,3046),
(401,3151),
(401,3178),
(401,3185),
(401,3178),
(401,3539),
(401,3592),
(401,3600),
(401,3643),
(401,3815),
(401,3862),
(401,3917),
(401,3920),
(401,4064),
(401,4072),
(401,4072),
(401,4434),
(401,4469),
(401,3917),
(401,4656),
(401,4698),
(401,4736),
(401,4760),
(401,4797),
(401,4801),
(401,4808),
(401,1026),
(401,4836),
(401,4837),
(401,4856),
(401,4898),
(401,5029),
(401,663),
(401,5233),
(401,5235),
(401,5263),
(401,5272),
(401,5339),
(401,5377),
(401,5654),
(401,5927),
(401,5951),
(401,6148),
(401,6134),
(401,6254),
(401,6266),
(401,6087),
(401,7003),
(401,7003),
(401,1237),
(401,7403),
(401,6807),
(401,1292)


)
                            AND ar.AR_TYPE = 4 ) i2
                JOIN
                    AR_TRANS art
                ON
                    art.CENTER = i2.CENTER
                    AND art.ID = i2.ID
                LEFT JOIN
                    INVOICES inv
                ON
                    inv.CENTER = art.REF_CENTER
                    AND inv.id = art.REF_ID
                    AND art.REF_TYPE = 'INVOICE'
                LEFT JOIN
                    INVOICELINES invl
                ON
                    invl.CENTER = inv.CENTER
                    AND invl.ID = inv.ID
                LEFT JOIN
                    PERSONS ip
                ON
                    ip.CENTER = invl.PERSON_CENTER
                    AND ip.ID = invl.PERSON_ID
                LEFT JOIN
                    CREDIT_NOTES cn
                ON
                    cn.CENTER = art.REF_CENTER
                    AND cn.ID = art.REF_ID
                    AND art.REF_TYPE = 'CREDIT_NOTE'
                LEFT JOIN
                    CREDIT_NOTE_LINES cnl
                ON
                    cnl.CENTER = cn.CENTER
                    AND cnl.ID = cn.ID
                LEFT JOIN
                    PERSONS cp
                ON
                    cp.CENTER = cnl.PERSON_CENTER
                    AND cp.ID = cnl.PERSON_ID
                GROUP BY
                    CASE
                        WHEN cnl.TOTAL_AMOUNT IS NOT NULL
                        THEN SIGN(18-floor(months_between(SYSDATE,cp.BIRTHDATE)/12) )
                        WHEN invl.TOTAL_AMOUNT IS NOT NULL
                        THEN SIGN(18 - floor(months_between(SYSDATE,ip.BIRTHDATE)/12) )
                        ELSE SIGN(18 - floor(months_between(SYSDATE,i2.BIRTHDATE)/12) )
                    END ,
                    i2.CUSTOMERCENTER,
                    i2.CUSTOMERID )i3
        GROUP BY
            i3.payer )i4