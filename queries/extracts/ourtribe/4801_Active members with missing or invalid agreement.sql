-- The extract is extracted from Exerp on 2026-02-08
--  
SELECT * FROM ( SELECT p.center ||'p'|| p.id AS member_id, p.external_id, p.fullname AS name, email.txtvalue AS email, false AS is_other_payer, CASE p.PERSONTYPE WHEN 0 THEN 'PRIVATE' WHEN 1 THEN 'STUDENT' WHEN 2 THEN 'STAFF' WHEN 3 THEN 'FRIEND' WHEN 4 THEN 'CORPORATE' WHEN 5 THEN 'ONEMANCORPORATE' WHEN 6 THEN 'FAMILY' WHEN 7 THEN 'SENIOR' WHEN 8 THEN 'GUEST' WHEN 9 THEN 'CHILD' WHEN 10 THEN 'EXTERNAL_STAFF' ELSE 'Undefined' END AS PERSONTYPE, CASE p.STATUS WHEN 0 THEN 'LEAD' WHEN 1 THEN 'ACTIVE' WHEN 2 THEN 'INACTIVE' WHEN 3 THEN 'TEMPORARYINACTIVE' WHEN 4 THEN 'TRANSFERRED' WHEN 5 THEN 'DUPLICATE' WHEN 6 THEN 'PROSPECT' WHEN 7 THEN 'DELETED' WHEN 8 THEN 'ANONYMIZED' WHEN 9 THEN 'CONTACT' ELSE 'Undefined' END AS PERSON_STATUS, CASE pag.STATE WHEN 1 THEN 'Created' WHEN 2 THEN 'Sent' WHEN 3 THEN 'Failed' WHEN 4 THEN 'OK' WHEN 5 THEN 'Ended, bank' WHEN 6 THEN 'Ended, clearing house' WHEN 7 THEN 'Ended, debtor' WHEN 8 THEN 'Cancelled, not sent' WHEN 9 THEN 'Cancelled, sent' WHEN 10 THEN 'Ended, creditor' WHEN 11 THEN 'No agreement' WHEN 12 THEN 'Cash payment (deprecated)' WHEN 13 THEN 'Agreement not needed (invoice payment)' WHEN 14 THEN 'Agreement information incomplete' WHEN 15 THEN 'Transfer' WHEN 16 THEN 'Agreement Recreated' WHEN 17 THEN 'Signature missing' ELSE 'No Agreement' END AS agreement_state FROM persons p JOIN account_receivables ar ON ar.customercenter = p.center AND ar.customerid = p.id AND ar.ar_type = 4 JOIN payment_accounts pa ON pa.center = ar.center AND pa.id = ar.id LEFT JOIN payment_agreements pag ON pag.center = pa.active_agr_center AND pag.id = pa.active_agr_id AND pag.subid = pa.active_agr_subid LEFT JOIN person_ext_attrs email ON email.personcenter = p.center AND email.personid = p.id AND email.name = '_eClub_Email' WHERE ( pag.center IS NULL OR pag.state != 4) AND p.status IN (1,3) AND p.sex != 'C' AND p.persontype != 2 AND NOT EXISTS ( SELECT 1 FROM persons per JOIN relatives r ON r.relativecenter = per.center AND r.relativeid = per.id AND r.rtype = 12 AND r.status < 2 WHERE per.center = p.center AND per.id = p.id ) AND p.center IN (:scope) UNION ALL SELECT op.center ||'p'|| op.id AS member_id, op.external_id, op.fullname AS name, opemail.txtvalue AS email, true AS is_other_payer, CASE op.PERSONTYPE WHEN 0 THEN 'PRIVATE' WHEN 1 THEN 'STUDENT' WHEN 2 THEN 'STAFF' WHEN 3 THEN 'FRIEND' WHEN 4 THEN 'CORPORATE' WHEN 5 THEN 'ONEMANCORPORATE' WHEN 6 THEN 'FAMILY' WHEN 7 THEN 'SENIOR' WHEN 8 THEN 'GUEST' WHEN 9 THEN 'CHILD' WHEN 10 THEN 'EXTERNAL_STAFF' ELSE 'Undefined' END AS PERSONTYPE, CASE op.STATUS WHEN 0 THEN 'LEAD' WHEN 1 THEN 'ACTIVE' WHEN 2 THEN 'INACTIVE' WHEN 3 THEN 'TEMPORARYINACTIVE' WHEN 4 THEN 'TRANSFERRED' WHEN 5 THEN 'DUPLICATE' WHEN 6 THEN 'PROSPECT' WHEN 7 THEN 'DELETED' WHEN 8 THEN 'ANONYMIZED' WHEN 9 THEN 'CONTACT' ELSE 'Undefined' END AS PERSON_STATUS, CASE oppag.STATE WHEN 1 THEN 'Created' WHEN 2 THEN 'Sent' WHEN 3 THEN 'Failed' WHEN 4 THEN 'OK' WHEN 5 THEN 'Ended, bank' WHEN 6 THEN 'Ended, clearing house' WHEN 7 THEN 'Ended, debtor' WHEN 8 THEN 'Cancelled, not sent' WHEN 9 THEN 'Cancelled, sent' WHEN 10 THEN 'Ended, creditor' WHEN 11 THEN 'No agreement' WHEN 12 THEN 'Cash payment (deprecated)' WHEN 13 THEN 'Agreement not needed (invoice payment)' WHEN 14 THEN 'Agreement information incomplete' WHEN 15 THEN 'Transfer' WHEN 16 THEN 'Agreement Recreated' WHEN 17 THEN 'Signature missing' ELSE 'No Agreement' END AS agreement_state FROM persons op JOIN relatives opr ON opr.center = op.center AND opr.id = op.id AND opr.rtype = 12 AND opr.status < 2 JOIN account_receivables opar ON opar.customercenter = op.center AND opar.customerid = op.id AND opar.ar_type = 4 JOIN payment_accounts oppa ON oppa.center = opar.center AND oppa.id = opar.id LEFT JOIN payment_agreements oppag ON oppag.center = oppa.active_agr_center AND oppag.id = oppa.active_agr_id AND oppag.subid = oppa.active_agr_subid LEFT JOIN person_ext_attrs opemail ON opemail.personcenter = op.center AND opemail.personid = op.id AND opemail.name = '_eClub_Email' WHERE ( oppag.center IS NULL OR oppag.state != 4) AND op.status IN (1,3) AND op.sex != 'C' AND op.center IN (:scope) ) t1 ORDER BY t1.member_id