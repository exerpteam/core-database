SELECT p.center AS "Centre ID" ,c.shortname AS "Centre name" ,p.external_id AS "Member id" ,p.firstname AS "First name" ,p.lastname AS "Last name" ,CASE p.persontype WHEN 0 THEN 'PRIVATE' WHEN 2 THEN 'STAFF' WHEN 8 THEN 'GUEST' ELSE 'OTHER' END AS "Person type" ,CASE p.status WHEN 0 THEN 'LEAD' WHEN 1 THEN 'ACTIVE' WHEN 2 THEN 'INACTIVE' WHEN 3 THEN CASE WHEN activesub.state = 4 THEN 'TEMPORARYINACTIVE-FROZEN' WHEN activesub.state = 8 THEN 'TEMPORARYINACTIVE-FUTURESTART' WHEN balance.balance < 0 THEN 'TEMPORARYINACTIVE-DEBT' ELSE 'TEMPORARYINACTIVE' END WHEN 4 THEN 'TRANSFERRED' WHEN 5 THEN 'DUPLICATE' WHEN 6 THEN 'PROSPECT' WHEN 7 THEN 'DELETED' WHEN 8 THEN 'ANONYMIZED' WHEN 9 THEN 'CONTACT' ELSE 'Undefined' END AS "Status" ,CASE WHEN activesub.subscription IS NOT NULL THEN activesub.subscription ELSE inactivesub.subscription END AS "Subscription" ,CASE WHEN activesub.state IS NOT NULL THEN CASE WHEN activesub.state= 2 THEN 'ACTIVE' WHEN activesub.state = 4 THEN 'FROZEN' WHEN activesub.state = 8 THEN 'CREATED' END WHEN inactivesub.state IS NOT NULL AND inactivesub.state = 3 THEN 'ENDED' WHEN inactivesub.state IS NOT NULL AND inactivesub.state = 7 THEN 'WINDOW' ELSE NULL END AS "Subscription status" ,CASE WHEN activesub.start_date IS NOT NULL THEN activesub.start_date ELSE inactivesub.start_date END AS "Start date" ,CASE WHEN activesub.end_date IS NOT NULL THEN activesub.end_date ELSE inactivesub.end_date END AS "End date" ,mobile.txtvalue AS "Mobile" ,email.txtvalue AS "Email" ,CASE WHEN debtcase.personcenter IS NULL THEN 'No' ELSE 'Yes' END AS "Debt case" ,visit.totalvisit AS "Visits" FROM persons p JOIN centers c ON c.id = p.center LEFT JOIN ( SELECT s.owner_center ,s.owner_id ,s.start_date ,s.end_date ,s.state ,prod.name AS subscription FROM subscriptions s JOIN subscriptiontypes st ON st.center = s.subscriptiontype_center AND st.id = s.subscriptiontype_id JOIN products prod ON prod.center = st.center AND prod.id = st.id WHERE s.state IN (2,4,8) )activesub ON activesub.owner_center = p.center AND activesub.owner_id = p.id LEFT JOIN ( SELECT s.owner_center ,s.owner_id ,s.start_date ,s.end_date ,s.state ,prod.name AS subscription ,s.id FROM subscriptions s JOIN (SELECT s.center ,max(s.id) as maxid ,s.owner_center ,s.owner_id FROM subscriptions s WHERE s.state NOT IN (2,4,8) GROUP BY s.center ,s.owner_center ,s.owner_id )sub ON sub.center = s.center AND sub.maxid = s.id JOIN subscriptiontypes st ON st.center = s.subscriptiontype_center AND st.id = s.subscriptiontype_id JOIN products prod ON prod.center = st.center AND prod.id = st.id WHERE s.state NOT IN (2,4,8) )inactivesub ON inactivesub.owner_center = p.center AND inactivesub.owner_id = p.id LEFT JOIN ( SELECT sum(ar.balance) as balance ,ar.customercenter ,ar.customerid FROM account_receivables ar GROUP BY ar.customercenter ,ar.customerid )balance ON p.center = balance.customercenter AND p.id = balance.customerid LEFT JOIN person_ext_attrs mobile ON mobile.personcenter = p.center AND mobile.personid = p.id AND mobile.name = '_eClub_PhoneSMS' LEFT JOIN person_ext_attrs email ON email.personcenter = p.center AND email.personid = p.id AND email.name = '_eClub_Email' LEFT JOIN ( SELECT count(t.visitdate) as totalvisit ,t.personcenter ,t.personid FROM ( SELECT DISTINCT t1.visitdate ,t1.personcenter ,t1.personid FROM ( SELECT TO_CHAR(longtodatec(a.start_time,a.center), 'YYYY-MM-DD HH24:MI') as visitdate ,a.person_center AS personcenter ,a.person_id AS personid ,'gym' AS type FROM attends a WHERE (CURRENT_DATE - (CAST(longtodatec(a.start_time,a.center) AS DATE))) < 30 UNION ALL SELECT TO_CHAR(longtodatec(p.start_time,p.center), 'YYYY-MM-DD HH24:MI') as visitdate ,p.participant_center AS personcenter ,p.participant_id AS personid ,'booking' AS type FROM participations p WHERE state = 'PARTICIPATION' AND (CURRENT_DATE - (CAST(longtodatec(p.start_time,p.center) AS DATE))) < 30 )t1 )t GROUP BY t.personcenter ,t.personid )visit ON visit.personcenter = p.center AND visit.personid = p.id LEFT JOIN ( SELECT cc.personcenter ,cc.personid ,cc.startdate FROM cashcollectioncases cc WHERE cc.closed = 'false' AND cc.missingpayment = 'true' )debtcase ON debtcase.personcenter = p.center AND debtcase.personid = p.id WHERE p.status NOT IN (7,4,5) AND p.center IN (:Scope) 