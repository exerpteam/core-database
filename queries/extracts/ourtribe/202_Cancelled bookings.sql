WITH params AS ( SELECT /*+ materialize */ datetolongC(TO_CHAR(CAST(:From AS DATE), 'YYYY-MM-dd HH24:MI'),c.id) AS FromDate, c.id AS CENTER_ID, CAST((datetolongC(TO_CHAR((CAST(:To AS DATE) + INTERVAL '1 day'), 'YYYY-MM-dd HH24:MI'),c.id) - 1) AS BIGINT) AS ToDate FROM centers c ) SELECT TO_CHAR(longtodateC(b.starttime,b.center),'DD-MM-YYYY') AS "Date" ,TO_CHAR(longtodateC(b.starttime,b.center),'HH24:MI') AS "Start" ,TO_CHAR(longtodateC(b.stoptime,b.center),'HH24:MI') AS "End" ,ac.name AS "Name" ,ins.fullname AS "Instructor(s)" ,b.state AS "State" ,b.cancellation_reason as "Reason" ,TO_CHAR(longtodateC(b.cancelation_time,b.center),'DD-MM-YYYY') AS "Date cancelled" ,staff.fullname AS "Cancelled by" ,c.name AS "Centre" ,acg.name AS "Activity group" ,br.name AS "Sal" FROM bookings b JOIN centers c ON c.ID = b.center JOIN activity ac ON b.activity = ac.id LEFT JOIN staff_usage su ON su.booking_center = b.center AND su.booking_id = b.id LEFT JOIN persons ins ON ins.center = su.person_center AND ins.id = su.person_id LEFT JOIN persons staff ON staff.center = b.cancelation_by_center AND staff.id = b.cancelation_by_id LEFT JOIN activity_group acg ON acg.id = ac.activity_group_id LEFT JOIN booking_resource_usage bru ON bru.booking_center = b.center AND bru.booking_id = b.id LEFT JOIN booking_resources br ON br.center = bru.booking_resource_center AND br.id = bru.booking_resource_id JOIN params ON params.CENTER_ID = b.center WHERE b.state = 'CANCELLED' AND b.starttime BETWEEN params.FromDate AND params.ToDate AND b.center in (:Scope) ORDER BY b.starttime 