WITH params AS ( SELECT /*+ materialize */ datetolongC(TO_CHAR(CAST(:From AS DATE), 'YYYY-MM-dd HH24:MI'),c.id) AS FromDate, c.id AS CENTER_ID, CAST((datetolongC(TO_CHAR((CAST(:To AS DATE) + INTERVAL '1 day'), 'YYYY-MM-dd HH24:MI'),c.id) - 1) AS BIGINT) AS ToDate FROM centers c ) SELECT p.external_id AS "Member id" ,p.fullname AS "Member name" ,c.shortname AS "Member club" ,s.start_date AS "Start date" ,prod.name AS "Subscription name" ,cc.code AS "Campaign" ,sc.name AS "Campaign name" ,sp.from_date AS "Campaign price start date" ,sp.to_date AS "Campaign price end date" ,CASE WHEN pp.price_modification_name = 'FREE' THEN 0 ELSE pp.price_modification_amount END AS "Campaign price" ,invl.total_amount AS "Campaign fee" ,s.end_date AS "Subscription stop date" ,currentsub.Currentsub AS "Latest subscription" ,currentsub.Substart AS "Latest subscription start date" ,currentsub.subscription_price AS "Latest subscription price" ,currentsub.Subend AS "Latest subscription end date" ,email.txtvalue AS "Email" FROM subscription_sales ss JOIN persons p ON p.center = ss.owner_center AND p.id = ss.owner_id JOIN centers c ON c.id = p.center JOIN subscriptions s ON s.center = ss.subscription_center AND s.id = ss.subscription_id JOIN subscriptiontypes st ON st.center = s.subscriptiontype_center AND st.id = s.subscriptiontype_id JOIN products prod ON prod.center = st.center AND prod.id = st.id JOIN subscription_price sp ON sp.subscription_center = s.center AND sp.subscription_id = s.id AND sp.type = 'INITIAL' JOIN privilege_usages pu ON sp.id = pu.target_id AND pu.target_service = 'SubscriptionPrice' AND pu.state = 'USED' JOIN privilege_grants pg ON pg.id = pu.grant_id JOIN campaign_codes cc ON pu.campaign_code_id = cc.id JOIN startup_campaign sc ON sc.id = cc.campaign_id AND cc.campaign_type ='STARTUP' JOIN product_privileges pp ON pp.privilege_set = pg.privilege_set AND pu.privilege_id = pp.id LEFT JOIN invoice_lines_mt invl ON invl.center = s.invoiceline_center AND invl.id = s.invoiceline_id AND invl.subid = s.invoiceline_subid LEFT JOIN (SELECT prod.name AS Currentsub ,s.start_date AS Substart ,s.end_date AS Subend ,s.subscription_price ,s.owner_center ,s.owner_id FROM subscriptions s JOIN subscriptiontypes st ON st.center = s.subscriptiontype_center AND st.id = s.subscriptiontype_id JOIN products prod ON prod.center = st.center AND prod.id = st.id WHERE s.state IN (2,4) )currentsub ON currentsub.owner_center = p.center AND currentsub.owner_id = p.id JOIN params ON params.CENTER_ID = p.center LEFT JOIN person_ext_attrs email ON email.personcenter = p.center AND email.personid = p.id AND email.name = '_eClub_Email' WHERE p.center IN (:Scope) AND s.CREATION_TIME BETWEEN params.FromDate AND params.ToDate 