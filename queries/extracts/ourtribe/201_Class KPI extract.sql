-- The extract is extracted from Exerp on 2026-02-08
--  
WITH params AS ( SELECT /*+ materialize */ datetolongC(TO_CHAR(CAST(:From AS DATE), 'YYYY-MM-dd HH24:MI'),c.id) AS FromDate, c.id AS CENTER_ID, CAST((datetolongC(TO_CHAR((CAST(:To AS DATE) + INTERVAL '1 day'), 'YYYY-MM-dd HH24:MI'),c.id) - 1) AS BIGINT) AS ToDate FROM centers c ) SELECT TO_CHAR(longtodateC(b.starttime,b.center),'DD-MM-YYYY') AS "Date" ,TO_CHAR(longtodateC(b.starttime,b.center),'Day') AS "Weekday" ,TO_CHAR(longtodateC(b.starttime,b.center),'HH24:MI') AS "Start" ,TO_CHAR(longtodateC(b.stoptime,b.center),'HH24:MI') AS "End" ,ac.name AS "Name" ,ins.fullname AS "Instructor(s)" ,b.class_capacity AS "Capacity" ,CASE WHEN booked.booked IS NULL THEN 0 ELSE booked.booked END AS "Bookings" ,CASE WHEN p.participants IS NULL THEN 0 ELSE p.participants END AS "Checkins" ,CASE WHEN ROUND(CAST(((booked.booked / b.class_capacity::float)*100) AS numeric),2) IS NULL THEN 0 ELSE ROUND(CAST(((booked.booked / b.class_capacity::float)*100) AS numeric),2) END AS "Attendance rate Booking %" ,CASE WHEN ROUND(CAST(((p.participants / b.class_capacity::float)*100) AS numeric),2) IS NULL THEN 0 ELSE ROUND(CAST(((p.participants / b.class_capacity::float)*100) AS numeric),2) END AS "Attendance rate Check in %" ,c.name AS "Centre" ,EXTRACT(week from CAST(longtodateC(b.starttime,b.center) AS DATE)) AS "Week" ,TO_CHAR(longtodateC(b.starttime,b.center),'Day') AS "Day" ,EXTRACT( YEAR FROM (longtodateC(b.starttime,b.center))) AS "Year" ,acg.name AS "Activity group" ,cg.name AS "Colour" ,br.name AS "Sal" ,longtodateC(b.stoptime,b.center) - longtodateC(b.starttime,b.center) AS "Timer" ,b.state as "STATE" FROM bookings b LEFT JOIN ( SELECT booking_center ,booking_id ,count(*) as booked FROM participations WHERE (cancelation_reason not in ('USER','BOOKING','CENTER','API') OR cancelation_reason IS NULL) GROUP BY booking_center,booking_id )booked ON booked.booking_center = b.center and booked.booking_id = b.id LEFT JOIN ( SELECT booking_center ,booking_id ,count(*) as participants FROM participations WHERE state = 'PARTICIPATION' GROUP BY booking_center,booking_id )p ON p.booking_center = b.center and p.booking_id = b.id JOIN centers c ON c.ID = b.center JOIN activity ac ON b.activity = ac.id LEFT JOIN staff_usage su ON su.booking_center = b.center AND su.booking_id = b.id LEFT JOIN persons ins ON ins.center = su.person_center AND ins.id = su.person_id LEFT JOIN colour_groups cg ON cg.id = b.colour_group_id LEFT JOIN activity_group acg ON acg.id = ac.activity_group_id LEFT JOIN booking_resource_usage bru ON bru.booking_center = b.center AND bru.booking_id = b.id LEFT JOIN booking_resources br ON br.center = bru.booking_resource_center AND br.id = bru.booking_resource_id JOIN params ON params.CENTER_ID = b.center WHERE b.starttime BETWEEN params.FromDate AND params.ToDate AND b.center in (:Scope) AND bru.state != 'CANCELLED' ORDER BY b.starttime 